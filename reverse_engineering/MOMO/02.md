# 桃华月惮 逆向工程笔记 02

本节主要记录解压算法的相关事项， `DataPack5` 采用了一种自制的压缩算法，原理相对简单。总的来说是给数据加窗，当信息已经读取过（已在窗口中时），便可以从窗口中读取，而不需要再从文件中读出了，通过这种方法来降低文件的冗余。

压缩后的文件中主要包含三部分，分别是 `OPCode` 、 `EA` 和 `Data` 。

## OPCode

`DataPack5` 的 `OPCode` 长度为一个 `Byte` ，也就是八个二进制， `DataPack5` 数据段一定是以 `OPCode` 开始的，一个典型的 `OPCode` 如下所示：
```
OPCode = 110110111
```
从低位（右）往高位读取，三个1意味从文件中读取随后3个`byte`的数据（同时将这部分数据存储于滑动窗中），一个0意味着从窗中读取一个`byte`的数据（这意味着这个数据是已经存储于窗中的了）......以此类推。

## EA (Effective Address)

既然要从滑动窗口中读出数据，就需要一个指针来取数据，`Offset` 便承担了这个职责。当 `OPCode` 处理位为0时，向后读取两个`Byte`的数据，第一个`Byte`作为`Offset`，第二个`Byte`作为`Segment`，两者组合为`Effective Address`，一个典型的`EA`的组成如下：
```
 Offset = 0xDC
Segment = 0xFF * 16
---> EA = Segment | Offset = 0x0FF0 | 0x00DC = 0x0FDC
```
这意味着系统需要将滑动窗口中，从`0x0FDC`开始的`1byte`数据追加到当前解压文件的最后尾。

## 总结

该压缩算法可以被简单的理解为，如果需要压缩一段字符，例如 `大大泡泡糖`， 通过滑动窗口压缩方法，则只需要在压缩后的文件中保存 `大泡糖` 三个字符。当然该算法绝非万能，因为存储`OPCode`和`EA`需要空间，同时滑动窗口并非无限大，增大滑动窗口也意味着`EA`的尺寸增大。
